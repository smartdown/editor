const smartdown=window.smartdown;function calcWikidataImageUtil(e,n,t,a){function s(){const n=this.responseText,t=JSON.parse(n).query.pages,s=[];t.forEach((function(n){e&&n.thumbnail?s.push(n.thumbnail.source):!e&&n.original&&s.push(n.original.source)})),s.elementType="image",a(s)}t=decodeURIComponent(t);let i=t;if(0===t.indexOf("[")){const e=JSON.parse(t);Array.isArray(e)&&(i="",e.forEach((function(n,t){i+=n,t<e.length-1&&(i+="|")})))}const o=new XMLHttpRequest;o.addEventListener("load",s);let c="https://en.wikipedia.org/w/api.php?action=query&prop=pageimages%7Cpageterms&format=json&origin=*&wbptterms=description&redirects=&formatversion=2";c+="&titles="+encodeURI(i),c+="&piprop=thumbnail%7Cname%7Coriginal&pithumbsize=300",o.open("GET",c),o.send()}function calcWikidataImages(e,n,t){return calcWikidataImageUtil(!1,e,n,t)}function calcWikidataThumbs(e,n,t){return calcWikidataImageUtil(!0,e,n,t)}function calcWikidata(e,n,t){function a(){const e=this.responseText,n=JSON.parse(e).query.pages,a=[];window.lodashEach(n,(function(e){a.push({title:e.displaytitle,url:e.canonicalurl})})),a.elementType="title/url",t(a)}n=decodeURIComponent(n);let s=n;if(0===n.indexOf("[")){const e=JSON.parse(n);Array.isArray(e)&&(s="",e.forEach((function(n,t){s+=n,t<e.length-1&&(s+="|")})))}const i=new XMLHttpRequest;i.addEventListener("load",a);let o="https://en.wikipedia.org/w/api.php?action=query&format=json&prop=info&origin=*&redirects=";o+="&titles="+encodeURI(s),o+="&inprop=displaytitle%7Curl",i.open("GET",o),i.send()}const tsvCalcHandlerCache={};function calcTSV(e,n,t){n=decodeURIComponent(n),0===n.indexOf("/http")&&(n=n.slice(1));const a=smartdown.expandHrefWithLinkRules(n,smartdown.linkRules);if(smartdown.d3){const n="CACHE_"+e+"_"+a;let s=tsvCalcHandlerCache[n];s?s.inProgressHandlers.length>0?s.inProgressHandlers.push(t):t(s.cachedResult):(s=tsvCalcHandlerCache[n]={inProgressHandlers:[t],cachedResult:null},smartdown.axios.get(a).then((function(e){const n=smartdown.d3.tsvParseRows(e.data);s.cachedResult=n;while(s.inProgressHandlers.length>0){const e=s.inProgressHandlers.pop();e(n)}})).catch((function(e){console.log("err",e)})))}else smartdown.ensureExtension("d3",(function(){calcTSV(e,a,t)}))}const csvCalcHandlerCache={};function calcCSV(e,n,t){n=decodeURIComponent(n),0===n.indexOf("/http")&&(n=n.slice(1));const a=smartdown.expandHrefWithLinkRules(n,smartdown.linkRules);if(smartdown.d3){const n="CACHE_"+e+"_"+a;let s=csvCalcHandlerCache[n];s?s.inProgressHandlers.length>0?(console.log("MISS cacheKey adding handler",n),s.inProgressHandlers.push(t)):t(s.cachedResult):(console.log("MISS cacheKey",n),s=csvCalcHandlerCache[n]={inProgressHandlers:[t],cachedResult:null},smartdown.axios.get(a).then((function(e){const n=smartdown.d3.csvParseRows(e.data);s.cachedResult=n;while(s.inProgressHandlers.length>0){const e=s.inProgressHandlers.pop();e(n)}})).catch((function(e){console.log("err",e)})))}else smartdown.ensureExtension("d3",(function(){calcCSV(e,a,t)}))}smartdown.defaultCalcHandlers={wikidataImages:calcWikidataImages,wikidataThumbs:calcWikidataThumbs,wikidata:calcWikidata,tsv:calcTSV,csv:calcCSV};